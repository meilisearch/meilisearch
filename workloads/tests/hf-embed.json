{
  "type": "test",
  "name": "hf-embed",
  "binary": {
    "source": "release",
    "edition": "community",
    "version": "1.14.0"
  },
  "assets": {
    "movies-100.json": {
      "local_location": null,
      "remote_location": "https://milli-benchmarks.fra1.digitaloceanspaces.com/bench/datasets/movies-100.json",
      "sha256": "d215e395e4240f12f03b8f1f68901eac82d9e7ded5b462cbf4a6b8efde76c6c6"
    }
  },
  "commands": [
    {
      "description": "initial settings for movies index",
      "route": "indexes/movies/settings",
      "method": "PATCH",
      "body": {
        "inline": {
          "filterableAttributes": [
            "genres",
            "release_date"
          ],
          "searchableAttributes": [
            "title",
            "overview"
          ],
          "sortableAttributes": [
            "release_date"
          ],
          "searchCutoffMs": 200000000
        }
      },
      "expectedStatus": 202,
      "expectedResponse": {
        "enqueuedAt": "[timestamp]",
        "indexUid": "movies",
        "status": "enqueued",
        "taskUid": 0,
        "type": "settingsUpdate"
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "add embedder for movies index",
      "route": "indexes/movies/settings",
      "method": "PATCH",
      "body": {
        "inline": {
          "embedders": {
            "default": {
              "source": "huggingFace",
              "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
              "distribution": {
                "mean": 0.5,
                "sigma": 0.4
              }
            }
          }
        }
      },
      "expectedStatus": 202,
      "expectedResponse": {
        "enqueuedAt": "[timestamp]",
        "indexUid": "movies",
        "status": "enqueued",
        "taskUid": 1,
        "type": "settingsUpdate"
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "add 100 movies to movies index for embedding",
      "route": "indexes/movies/documents",
      "method": "POST",
      "body": {
        "asset": "movies-100.json"
      },
      "expectedStatus": 202,
      "expectedResponse": {
        "enqueuedAt": "[timestamp]",
        "indexUid": "movies",
        "status": "enqueued",
        "taskUid": 2,
        "type": "documentAdditionOrUpdate"
      },
      "synchronous": "WaitForTask"
    },
    {
      "description": "initial search with arroy, register results",
      "route": "indexes/movies/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "register": {
        "hit0": "/hits/0/id",
        "hit1": "/hits/1/id",
        "hit2": "/hits/2/id",
        "hit3": "/hits/3/id",
        "hit4": "/hits/4/id",
        "hit0score": "/hits/0/_rankingScore",
        "hit1score": "/hits/1/_rankingScore",
        "hit2score": "/hits/2/_rankingScore",
        "hit3score": "/hits/3/_rankingScore",
        "hit4score": "/hits/4/_rankingScore"
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "check embedder settings",
      "route": "indexes/movies/settings/embedders",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "default": {
          "distribution": {
            "mean": 0.5,
            "sigma": 0.4
          },
          "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
          "documentTemplateMaxBytes": 400,
          "model": "BAAI/bge-base-en-v1.5",
          "pooling": "useModel",
          "revision": "617ca489d9e86b49b8167676d8220688b99db36e",
          "source": "huggingFace"
        }
      },
      "synchronous": "WaitForResponse"
    },
    {
      "binary": {
        "description": "last version where arroy is available, no update task",
        "source": "release",
        "version": "1.35.1",
        "edition": "community",
        "extraCliArgs": [
          "--experimental-dumpless-upgrade",
          "--experimental-max-number-of-batched-tasks=0"
        ]
      }
    },
    {
      "description": "enable vectorStore setting",
      "route": "experimental-features",
      "method": "PATCH",
      "body": {
        "inline": {
          "vectorStoreSetting": true
        }
      },
      "expectedStatus": 200,
      "synchronous": "WaitForResponse"
    },
    {
      "description": "search results haven't changed for movies",
      "route": "indexes/movies/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "expectedStatus": 200,
      "expectedResponse": {
        "estimatedTotalHits": 99,
        "hits": [
          {
            "_rankingScore": "{{ hit0score }}",
            "id": "{{ hit0 }}"
          },
          {
            "_rankingScore": "{{ hit1score }}",
            "id": "{{ hit1 }}"
          },
          {
            "_rankingScore": "{{ hit2score }}",
            "id": "{{ hit2 }}"
          },
          {
            "_rankingScore": "{{ hit3score }}",
            "id": "{{ hit3 }}"
          },
          {
            "_rankingScore": "{{ hit4score }}",
            "id": "{{ hit4 }}"
          }
        ],
        "limit": 5,
        "offset": 0,
        "processingTimeMs": "[duration]",
        "query": "Police",
        "requestUid": "[uuid]",
        "semanticHitCount": 5
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "settings haven't changed for movies embedder",
      "route": "indexes/movies/settings/embedders",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "default": {
          "distribution": {
            "mean": 0.5,
            "sigma": 0.4
          },
          "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
          "documentTemplateMaxBytes": 400,
          "model": "BAAI/bge-base-en-v1.5",
          "pooling": "useModel",
          "revision": "617ca489d9e86b49b8167676d8220688b99db36e",
          "source": "huggingFace"
        }
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "check that the vector store is the default (arroy)",
      "route": "indexes/movies/settings/vector-store",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": null,
      "synchronous": "WaitForResponse"
    },
    {
      "binary": {
        "description": "perform upgrade task",
        "source": "release",
        "version": "1.35.1",
        "edition": "community",
        "extraCliArgs": [
          "--experimental-dumpless-upgrade"
        ]
      }
    },
    {
      "description": "wait for upgrade task to complete",
      "route": "health",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "status": "available"
      },
      "synchronous": "WaitForTask"
    },
    {
      "description": "creates movies-hannoy index with same settings as movies, but using hannoy",
      "route": "indexes/movies-hannoy/settings",
      "method": "PATCH",
      "body": {
        "inline": {
          "filterableAttributes": [
            "genres",
            "release_date"
          ],
          "searchableAttributes": [
            "title",
            "overview"
          ],
          "sortableAttributes": [
            "release_date"
          ],
          "embedders": {
            "default": {
              "source": "huggingFace",
              "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
              "distribution": {
                "mean": 0.5,
                "sigma": 0.4
              }
            }
          },
          "searchCutoffMs": 200000000
        }
      },
      "expectedStatus": 202,
      "expectedResponse": {
        "enqueuedAt": "[timestamp]",
        "indexUid": "movies-hannoy",
        "status": "enqueued",
        "taskUid": 4,
        "type": "settingsUpdate"
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "embed same docs as for arroy index",
      "route": "indexes/movies-hannoy/documents",
      "method": "POST",
      "body": {
        "asset": "movies-100.json"
      },
      "expectedStatus": 202,
      "expectedResponse": {
        "enqueuedAt": "[timestamp]",
        "indexUid": "movies-hannoy",
        "status": "enqueued",
        "taskUid": 5,
        "type": "documentAdditionOrUpdate"
      },
      "synchronous": "WaitForTask"
    },
    {
      "description": "check that the vector store is hannoy",
      "route": "indexes/movies-hannoy/settings/vector-store",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": "experimental",
      "synchronous": "WaitForResponse"
    },
    {
      "description": "search results didn't change for arroy index post-upgrade",
      "route": "indexes/movies/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "expectedStatus": 200,
      "expectedResponse": {
        "estimatedTotalHits": 99,
        "hits": [
          {
            "_rankingScore": "[rankingScore]",
            "id": "{{ hit0 }}"
          },
          {
            "_rankingScore": "{{ hit1score }}",
            "id": "{{ hit1 }}"
          },
          {
            "_rankingScore": "{{ hit2score }}",
            "id": "{{ hit2 }}"
          },
          {
            "_rankingScore": "{{ hit3score }}",
            "id": "{{ hit3 }}"
          },
          {
            "_rankingScore": "{{ hit4score }}",
            "id": "{{ hit4 }}"
          }
        ],
        "limit": 5,
        "offset": 0,
        "processingTimeMs": "[duration]",
        "query": "Police",
        "requestUid": "[uuid]",
        "semanticHitCount": 5
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "register results for the index using hannoy",
      "route": "indexes/movies-hannoy/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "register": {
        "hitHannoy0": "/hits/0/id",
        "hitHannoy1": "/hits/1/id",
        "hitHannoy2": "/hits/2/id",
        "hitHannoy3": "/hits/3/id",
        "hitHannoy4": "/hits/4/id",
        "hitHannoy0score": "/hits/0/_rankingScore",
        "hitHannoy1score": "/hits/1/_rankingScore",
        "hitHannoy2score": "/hits/2/_rankingScore",
        "hitHannoy3score": "/hits/3/_rankingScore",
        "hitHannoy4score": "/hits/4/_rankingScore"
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "check embedder settings one more time (?)",
      "route": "indexes/movies/settings/embedders",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "default": {
          "distribution": {
            "mean": 0.5,
            "sigma": 0.4
          },
          "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
          "documentTemplateMaxBytes": 400,
          "model": "BAAI/bge-base-en-v1.5",
          "pooling": "useModel",
          "revision": "617ca489d9e86b49b8167676d8220688b99db36e",
          "source": "huggingFace"
        }
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "check embedding settings for hannoy index",
      "route": "indexes/movies-hannoy/settings/embedders",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "default": {
          "distribution": {
            "mean": 0.5,
            "sigma": 0.4
          },
          "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
          "documentTemplateMaxBytes": 400,
          "model": "BAAI/bge-base-en-v1.5",
          "pooling": "useModel",
          "revision": "617ca489d9e86b49b8167676d8220688b99db36e",
          "source": "huggingFace"
        }
      },
      "synchronous": "WaitForResponse"
    },
    {
      "binary": {
        "description": "current binary migrates arroy indexes to hannoy indexes, no upgrade task",
        "source": "build",
        "edition": "community",
        "extraCliArgs": [
          "--experimental-dumpless-upgrade",
          "--experimental-max-number-of-batched-tasks=0"
        ]
      }
    },
    {
      "description": "results didn't change for arroy index because no upgrade",
      "route": "indexes/movies/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "expectedStatus": 200,
      "expectedResponse": {
        "estimatedTotalHits": 99,
        "hits": [
          {
            "_rankingScore": "{{ hit0score }}",
            "id": "{{ hit0 }}"
          },
          {
            "_rankingScore": "{{ hit1score }}",
            "id": "{{ hit1 }}"
          },
          {
            "_rankingScore": "{{ hit2score }}",
            "id": "{{ hit2 }}"
          },
          {
            "_rankingScore": "{{ hit3score }}",
            "id": "{{ hit3 }}"
          },
          {
            "_rankingScore": "{{ hit4score }}",
            "id": "{{ hit4 }}"
          }
        ],
        "limit": 5,
        "offset": 0,
        "processingTimeMs": "[duration]",
        "query": "Police",
        "requestUid": "[uuid]",
        "semanticHitCount": 5
      },
      "synchronous": "WaitForResponse"
    },
    {
      "binary": {
        "description": "apply upgrade task",
        "source": "build",
        "edition": "community",
        "extraCliArgs": [
          "--experimental-dumpless-upgrade"
        ]
      }
    },
    {
      "description": "wait for upgrade task to complete",
      "route": "health",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "status": "available"
      },
      "synchronous": "WaitForTask"
    },
    {
      "description": "arroy was migrated to hannoy",
      "route": "indexes/movies/settings/vector-store",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": "experimental",
      "synchronous": "WaitForResponse"
    },
    {
      "description": "results didn't change for hannoy index",
      "route": "indexes/movies-hannoy/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "expectedStatus": 200,
      "expectedResponse": {
        "estimatedTotalHits": 99,
        "hits": [
          {
            "_rankingScore": "{{ hitHannoy0score }}",
            "id": "{{ hitHannoy0 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy1score }}",
            "id": "{{ hitHannoy1 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy2score }}",
            "id": "{{ hitHannoy2 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy3score }}",
            "id": "{{ hitHannoy3 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy4score }}",
            "id": "{{ hitHannoy4 }}"
          }
        ],
        "limit": 5,
        "offset": 0,
        "processingTimeMs": "[duration]",
        "query": "Police",
        "requestUid": "[uuid]",
        "semanticHitCount": 5
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "results became the same as hannoy index for (formerly) arroy index",
      "route": "indexes/movies/search",
      "method": "POST",
      "body": {
        "inline": {
          "attributesToRetrieve": [
            "id"
          ],
          "hybrid": {
            "embedder": "default",
            "semanticRatio": 1.0
          },
          "limit": 5,
          "q": "Police",
          "showRankingScore": true
        }
      },
      "expectedStatus": 200,
      "expectedResponse": {
        "estimatedTotalHits": 99,
        "hits": [
          {
            "_rankingScore": "{{ hitHannoy0score }}",
            "id": "{{ hitHannoy0 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy1score }}",
            "id": "{{ hitHannoy1 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy2score }}",
            "id": "{{ hitHannoy2 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy3score }}",
            "id": "{{ hitHannoy3 }}"
          },
          {
            "_rankingScore": "{{ hitHannoy4score }}",
            "id": "{{ hitHannoy4 }}"
          }
        ],
        "limit": 5,
        "offset": 0,
        "processingTimeMs": "[duration]",
        "query": "Police",
        "requestUid": "[uuid]",
        "semanticHitCount": 5
      },
      "synchronous": "WaitForResponse"
    },
    {
      "description": "summary of tasks",
      "route": "tasks",
      "method": "GET",
      "body": null,
      "expectedStatus": 200,
      "expectedResponse": {
        "from": 6,
        "limit": 20,
        "next": null,
        "results": [
          {
            "batchUid": 6,
            "canceledBy": null,
            "details": {
              "upgradeFrom": "v1.35.1",
              "upgradeTo": "[latest]"
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": null,
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "upgradeDatabase",
            "uid": 6
          },
          {
            "batchUid": 5,
            "canceledBy": null,
            "details": {
              "indexedDocuments": 99,
              "receivedDocuments": 99
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": "movies-hannoy",
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "documentAdditionOrUpdate",
            "uid": 5
          },
          {
            "batchUid": 4,
            "canceledBy": null,
            "details": {
              "embedders": {
                "default": {
                  "distribution": {
                    "mean": 0.5,
                    "sigma": 0.4
                  },
                  "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
                  "source": "huggingFace"
                }
              },
              "filterableAttributes": [
                "genres",
                "release_date"
              ],
              "searchCutoffMs": 200000000,
              "searchableAttributes": [
                "title",
                "overview"
              ],
              "sortableAttributes": [
                "release_date"
              ]
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": "movies-hannoy",
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "settingsUpdate",
            "uid": 4
          },
          {
            "batchUid": 3,
            "canceledBy": null,
            "details": {
              "upgradeFrom": "v1.14.0",
              "upgradeTo": "v1.35.1"
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": null,
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "upgradeDatabase",
            "uid": 3
          },
          {
            "batchUid": 2,
            "canceledBy": null,
            "details": {
              "indexedDocuments": 99,
              "receivedDocuments": 99
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": "movies",
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "documentAdditionOrUpdate",
            "uid": 2
          },
          {
            "batchUid": 1,
            "canceledBy": null,
            "details": {
              "embedders": {
                "default": {
                  "distribution": {
                    "mean": 0.5,
                    "sigma": 0.4
                  },
                  "documentTemplate": "A movie titled {{doc.title}} about {{doc.overview|truncatewords:10}}…",
                  "source": "huggingFace"
                }
              }
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": "movies",
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "settingsUpdate",
            "uid": 1
          },
          {
            "batchUid": 0,
            "canceledBy": null,
            "details": {
              "filterableAttributes": [
                "genres",
                "release_date"
              ],
              "searchCutoffMs": 200000000,
              "searchableAttributes": [
                "title",
                "overview"
              ],
              "sortableAttributes": [
                "release_date"
              ]
            },
            "duration": "[duration]",
            "enqueuedAt": "[timestamp]",
            "error": null,
            "finishedAt": "[timestamp]",
            "indexUid": "movies",
            "startedAt": "[timestamp]",
            "status": "succeeded",
            "type": "settingsUpdate",
            "uid": 0
          }
        ],
        "total": 7
      },
      "synchronous": "WaitForResponse"
    }
  ]
}