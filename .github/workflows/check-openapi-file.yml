name: Check OpenAPI file

on:
  workflow_dispatch:
  pull_request:
  schedule:
    # Run daily at 5 AM UTC
    - cron: '0 5 * * *'

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-D warnings"

jobs:
  check-openapi:
    name: Check OpenAPI specification
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2.8.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenAPI tools
        run: npm install -g @apidevtools/swagger-cli @stoplight/spectral-cli

      - name: Check all routes have summaries
        run: cargo run --release -p openapi-generator -- --check-summaries

      - name: Check for duplicate or malformed paths
        run: cargo run --release -p openapi-generator -- --check-paths

      - name: Check OpenAPI documentation (routes, params, response examples, schema properties)
        run: cargo run --release -p openapi-generator -- --check-docs

      - name: Generate OpenAPI file
        run: cargo run --release -p openapi-generator -- --pretty --output /tmp/meilisearch-openapi.json

      # Validates that the OpenAPI file is syntactically correct and conforms to the OpenAPI specification
      - name: Validate OpenAPI schema
        run: swagger-cli validate /tmp/meilisearch-openapi.json

      # Lints the OpenAPI file for best practices (descriptions, examples, naming conventions, etc.)
      # Ruleset is defined in crates/openapi-generator/.spectral.yaml
      - name: Lint OpenAPI specification
        run: spectral lint /tmp/meilisearch-openapi.json --ruleset crates/openapi-generator/.spectral.yaml
